import{r as l,j as o,f as Z}from"./index-CQm69G5y.js";import{H as $}from"./heart-Bu9sRfTu.js";const v="likedRoutes",F="https://tracker.cernetic.cc/api/lpp-all-routes",J=p=>{try{const d=localStorage.getItem(p);return d?JSON.parse(d):[]}catch{return[]}},O=(p,d)=>{try{localStorage.setItem(p,JSON.stringify(d))}catch{}},U=({gpsPositions:p,activeStation:d,ijppArrivals:k,lppArrivals:x,szArrivals:L,getTripFromId:_})=>{const[h,M]=l.useState(""),[r,T]=l.useState(""),[m,j]=l.useState("arrivals"),[N,D]=l.useState(()=>J(v)),[b,I]=l.useState([]);l.useEffect(()=>{const e=setTimeout(()=>{T(h)},300);return()=>clearTimeout(e)},[h]),l.useEffect(()=>{(async()=>{try{const t=await fetch(F);if(!t.ok)throw new Error("Network response was not ok");const n=await t.json();I((n==null?void 0:n.data)||[])}catch{I([])}})()},[]);const f=l.useMemo(()=>{const e=s=>!((s==null?void 0:s.operator)==="Ljubljanski potniški promet d.o.o."&&!(s!=null&&s.lineName)),t=[],n=new Set;for(const s of p.filter(e)){const i=s.lineName||s.route_name;i&&!n.has(i)&&(n.add(i),t.push(s))}return t},[p]),u=l.useCallback(e=>(e==null?void 0:e.lineName)||(e==null?void 0:e.route_name),[]),z=l.useCallback(e=>{const t=u(e);return N.some(n=>n.id===t)},[N,u]),w=l.useCallback((e,t)=>{t==null||t.stopPropagation();const n=u(e);D(s=>{const a=s.some(c=>c.id===n)?s.filter(c=>c.id!==n):[...s,{id:n,name:e.lineName||e.route_name,lineNumber:e.lineNumber||e.routeName,operator:e.operator||e.operatorName,headsign:e.headsign||e.tripName,tripId:e.tripId,lineId:e.lineId,routeId:e.routeId}];return O(v,a),a})},[u]),C=e=>{const t=(e==null?void 0:e.operator)||(e==null?void 0:e.operatorName),n=e==null?void 0:e.type;return n==="LPP"||t!=null&&t.includes("Ljubljanski potniški promet")?"var(--lpp-color)":n==="SZ"||t!=null&&t.includes("slovenske železnice")?"var(--sz-color)":t!=null&&t.includes("Nomago")?"var(--nomago-color)":t!=null&&t.includes("Marprom")?"var(--marprom-color)":t!=null&&t.includes("Arriva")?"var(--arriva-color)":t!=null&&t.includes("Murska")?"var(--murska-color)":"var(--default-color)"},E=(e,t)=>{if(!e||!t)return"N/A";const n=new Date(e),s=new Date(t);if(isNaN(n)||isNaN(s))return"N/A";const i=Math.round((s-n)/6e4);return i===0?" 0 min":i>0?` ${i} min`:` -${i} min`},y=l.useMemo(()=>{const e=(k||[]).filter(s=>{var i;return(i=s==null?void 0:s.tripName)==null?void 0:i.toLowerCase().includes(r.toLowerCase())}).filter(s=>{var i;return!((i=s==null?void 0:s.operatorName)!=null&&i.toLowerCase().includes("ljubljanski potniški promet"))||(s==null?void 0:s.etaMinutes)>60}).map(s=>({...s,type:"IJPP"})),t=(x||[]).filter(s=>{var i,a;return((i=s.tripName)==null?void 0:i.toLowerCase().includes(r.toLowerCase()))||((a=s.routeName)==null?void 0:a.toLowerCase().includes(r.toLowerCase()))}).map(s=>({...s,type:"LPP"})),n=(L||[]).filter(s=>{var i;return(i=s.headsign)==null?void 0:i.toLowerCase().includes(r.toLowerCase())}).map(s=>({...s,type:"SZ"}));return[...e,...t,...n].sort((s,i)=>(s.etaMinutes??1/0)-(i.etaMinutes??1/0))},[k,x,L,r]),R=l.useMemo(()=>{if(r.length<1)return[];const e=r.toLowerCase(),t=b.filter(n=>{var s,i;return((s=n==null?void 0:n.route_number)==null?void 0:s.toString().toLowerCase().includes(e))||((i=n==null?void 0:n.route_name)==null?void 0:i.toLowerCase().includes(e))}).map(n=>({lineName:n.route_name,lineNumber:n.route_number,tripId:n.trip_id,routeId:n.route_id,lineId:n.route_id,operator:"Ljubljanski potniški promet d.o.o."}));if(r.length>=3){const n=f.filter(a=>{var c;return(c=a.lineName||a.route_name||a.lineNumber)==null?void 0:c.toLowerCase().includes(e)}),s=[...t],i=new Set(s.map(a=>u(a)));for(const a of n){const c=u(a);i.has(c)||(i.add(c),s.push(a))}return s}return t},[r,b,f,u]),S=l.useMemo(()=>N.filter(e=>(e.name||e.lineNumber||"").toLowerCase().includes(r.toLowerCase())),[N,r]),g=async(e,t)=>{var i,a;if(!e.tripId&&!e.lineId&&!e.routeId){console.warn("No valid trip/line ID for route",e);return}const n=t||((i=e.operator)!=null&&i.includes("Slovenske železnice")?"SZ":(a=e.operator)!=null&&a.includes("Ljubljanski potniški promet")?"LPP":"IJPP");if(await _(e,n)){try{sessionStorage.setItem("openRouteDrawer","1")}catch{}window.location.hash="/map"}},P=({item:e,isLiked:t,onToggleLike:n,onClick:s})=>{var i;return o.jsxs("div",{className:"route-item",onClick:s,children:[o.jsx("div",{className:"circle",style:{background:C(e)},children:e.lineNumber??e.routeName??((i=e.tripId)==null?void 0:i.slice(5))??"?"}),o.jsx("h3",{children:e.lineName||e.headsign||e.name||e.tripName}),o.jsx("button",{className:`like-btn ${t?"liked":""}`,onClick:n,"aria-label":t?"Odstrani iz priljubljenih":"Dodaj med priljubljene",children:o.jsx($,{size:20,fill:t?"currentColor":"none"})})]})},A=({arrival:e})=>o.jsxs("div",{className:"arrival-item",onClick:()=>g(e,e.type),children:[o.jsxs("div",{className:"left",children:[o.jsx("div",{className:"circle",style:{background:C(e)},children:o.jsx("h2",{style:{fontSize:e.type==="SZ"?16:20,fontWeight:"bold"},children:e.type==="LPP"?e.routeName:e.routeShortName||e.tripName})}),o.jsx("h3",{children:e.tripName||e.headsign})]}),o.jsx("p",{children:Z(e)}),e.type==="SZ"&&o.jsx("p",{children:"Zamuda: "+E(e.scheduledDeparture,e.actualDeparture)})]});return o.jsxs("div",{className:"insideDiv",children:[o.jsxs("h2",{children:["Linije ","("+(d==null?void 0:d.name)+")"]}),o.jsx("input",{type:"text",placeholder:m==="arrivals"?"Išči po številki linije...":"Išči linije...",className:"search-input",value:h,onChange:e=>M(e.target.value)}),o.jsxs("div",{className:"top-nav",children:[o.jsx("button",{className:m==="arrivals"?"active":"",onClick:()=>j("arrivals"),children:"Prihodi"}),o.jsx("button",{className:m==="all"?"active":"",onClick:()=>j("all"),children:"Vse"}),o.jsx("button",{className:m==="liked"?"active":"",onClick:()=>j("liked"),children:"Priljubljene"})]}),o.jsxs("div",{className:"results",children:[m==="arrivals"&&o.jsxs("div",{className:"arrival-list",children:[y.length===0&&o.jsx("p",{className:"empty-message",children:"Ni prihodov na tej postaji."}),y.map((e,t)=>o.jsx(A,{arrival:e},`arrival-${t}`))]}),m==="all"&&o.jsxs(o.Fragment,{children:[h.length<1&&o.jsx("p",{className:"empty-message",children:"Vnesite številko linije ali ime."}),h.length>=1&&R.length===0&&o.jsx("p",{className:"empty-message",children:"Ni rezultatov."}),o.jsx("ul",{className:"route-list",children:R.map((e,t)=>o.jsx(P,{item:e,isLiked:z(e),onToggleLike:n=>w(e,n),onClick:()=>g(e)},`route-${t}`))})]}),m==="liked"&&o.jsxs(o.Fragment,{children:[S.length===0&&o.jsx("p",{className:"empty-message",children:"Ni priljubljenih linij. Kliknite na ❤️ za dodajanje."}),o.jsx("ul",{className:"route-list",children:S.map((e,t)=>{const s=f.find(i=>u(i)===e.id)||{lineName:e.name,lineNumber:e.lineNumber,operator:e.operator,headsign:e.headsign,tripId:e.tripId,lineId:e.lineId,routeId:e.routeId};return o.jsx(P,{item:s,isLiked:!0,onToggleLike:i=>w(s,i),onClick:()=>g(s)},`liked-${t}`)})})]})]})]})};export{U as default};
