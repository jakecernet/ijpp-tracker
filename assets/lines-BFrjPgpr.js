import{r,j as i,f as Z}from"./index-DQfCIfAk.js";import{H as $}from"./heart-1HfGplfo.js";const _="likedRoutes",F="https://tracker.cernetic.cc/api/lpp-all-routes",J=p=>{try{const d=localStorage.getItem(p);return d?JSON.parse(d):[]}catch{return[]}},O=(p,d)=>{try{localStorage.setItem(p,JSON.stringify(d))}catch{}},U=({gpsPositions:p,activeStation:d,ijppArrivals:g,lppArrivals:L,szArrivals:b,getTripFromId:T})=>{const[h,D]=r.useState(""),[a,M]=r.useState(""),[m,j]=r.useState("arrivals"),[N,v]=r.useState(()=>J(_)),[x,I]=r.useState([]);r.useEffect(()=>{const e=setTimeout(()=>{M(h)},300);return()=>clearTimeout(e)},[h]),r.useEffect(()=>{(async()=>{try{const t=await fetch(F);if(!t.ok)throw new Error("Network response was not ok");const n=await t.json();I((n==null?void 0:n.data)||[])}catch{I([])}})()},[]);const f=r.useMemo(()=>{const e=s=>!((s==null?void 0:s.operator)==="Ljubljanski potniški promet d.o.o."&&!(s!=null&&s.lineName)),t=[],n=new Set;for(const s of p.filter(e)){const o=s.lineName||s.route_name;o&&!n.has(o)&&(n.add(o),t.push(s))}return t},[p]),u=r.useCallback(e=>(e==null?void 0:e.lineName)||(e==null?void 0:e.route_name),[]),z=r.useCallback(e=>{const t=u(e);return N.some(n=>n.id===t)},[N,u]),w=r.useCallback((e,t)=>{t==null||t.stopPropagation();const n=u(e);v(s=>{const l=s.some(c=>c.id===n)?s.filter(c=>c.id!==n):[...s,{id:n,name:e.lineName||e.route_name,lineNumber:e.lineNumber||e.routeName,operator:e.operator||e.operatorName,headsign:e.headsign||e.tripName,tripId:e.tripId,lineId:e.lineId,routeId:e.routeId}];return O(_,l),l})},[u]),C=e=>{const t=(e==null?void 0:e.operator)||(e==null?void 0:e.operatorName),n=e==null?void 0:e.type;return n==="LPP"||t!=null&&t.includes("Ljubljanski potniški promet")?"var(--lpp-color)":n==="SZ"||t!=null&&t.includes("slovenske železnice")?"var(--sz-color)":t!=null&&t.includes("Nomago")?"var(--nomago-color)":t!=null&&t.includes("Marprom")?"var(--marprom-color)":t!=null&&t.includes("Arriva")?"var(--arriva-color)":t!=null&&t.includes("Murska")?"var(--murska-color)":"var(--default-color)"},E=(e,t)=>{if(!e||!t)return"N/A";const n=new Date(e),s=new Date(t);if(isNaN(n)||isNaN(s))return"N/A";const o=Math.round((s-n)/6e4);return o===0?" 0 min":o>0?` ${o} min`:` -${o} min`},y=r.useMemo(()=>{const e=(g||[]).filter(s=>{var o;return(o=s==null?void 0:s.tripName)==null?void 0:o.toLowerCase().includes(a.toLowerCase())}).filter(s=>(s==null?void 0:s.operatorName)!=="Ljubljanski Potniški Promet").filter(s=>!((s==null?void 0:s.operatorName)=="Ljubljanski potniški promet, d.o.o."&&(s==null?void 0:s.etaMinutes)<60)).map(s=>({...s,type:"IJPP"})),t=(L||[]).filter(s=>{var o,l;return((o=s.tripName)==null?void 0:o.toLowerCase().includes(a.toLowerCase()))||((l=s.routeName)==null?void 0:l.toLowerCase().includes(a.toLowerCase()))}).map(s=>({...s,type:"LPP"})),n=(b||[]).filter(s=>{var o;return(o=s.headsign)==null?void 0:o.toLowerCase().includes(a.toLowerCase())}).map(s=>({...s,type:"SZ"}));return[...e,...t,...n]},[g,L,b,a]),R=r.useMemo(()=>{if(a.length<1)return[];const e=a.toLowerCase(),t=x.filter(n=>{var s,o;return((s=n==null?void 0:n.route_number)==null?void 0:s.toString().toLowerCase().includes(e))||((o=n==null?void 0:n.route_name)==null?void 0:o.toLowerCase().includes(e))}).map(n=>({lineName:n.route_name,lineNumber:n.route_number,tripId:n.trip_id,routeId:n.route_id,lineId:n.route_id,operator:"Ljubljanski potniški promet d.o.o."}));if(a.length>=3){const n=f.filter(l=>{var c;return(c=l.lineName||l.route_name||l.lineNumber)==null?void 0:c.toLowerCase().includes(e)}),s=[...t],o=new Set(s.map(l=>u(l)));for(const l of n){const c=u(l);o.has(c)||(o.add(c),s.push(l))}return s}return t},[a,x,f,u]),S=r.useMemo(()=>N.filter(e=>(e.name||e.lineNumber||"").toLowerCase().includes(a.toLowerCase())),[N,a]),k=async(e,t)=>{var o,l;if(!e.tripId&&!e.lineId&&!e.routeId){console.warn("No valid trip/line ID for route",e);return}const n=t||((o=e.operator)!=null&&o.includes("Slovenske železnice")?"SZ":(l=e.operator)!=null&&l.includes("Ljubljanski potniški promet")?"LPP":"IJPP");if(await T(e,n)){try{sessionStorage.setItem("openRouteDrawer","1")}catch{}window.location.hash="/map"}},P=({item:e,isLiked:t,onToggleLike:n,onClick:s})=>{var o;return i.jsxs("div",{className:"route-item",onClick:s,children:[i.jsx("div",{className:"circle",style:{background:C(e)},children:e.lineNumber??e.routeName??((o=e.tripId)==null?void 0:o.slice(5))??"?"}),i.jsx("h3",{children:e.lineName||e.headsign||e.name||e.tripName}),i.jsx("button",{className:`like-btn ${t?"liked":""}`,onClick:n,"aria-label":t?"Odstrani iz priljubljenih":"Dodaj med priljubljene",children:i.jsx($,{size:20,fill:t?"currentColor":"none"})})]})},A=({arrival:e})=>i.jsxs("div",{className:"arrival-item",onClick:()=>k(e,e.type),children:[i.jsxs("div",{className:"left",children:[i.jsx("div",{className:"circle",style:{background:C(e)},children:i.jsx("h2",{style:{fontSize:e.type==="SZ"?16:20,fontWeight:"bold"},children:e.type==="LPP"?e.routeName:e.routeShortName||e.tripName})}),i.jsx("h3",{children:e.tripName||e.headsign})]}),i.jsx("p",{children:Z(e)}),e.type==="SZ"&&i.jsx("p",{children:"Zamuda: "+E(e.scheduledDeparture,e.actualDeparture)})]});return i.jsxs("div",{className:"insideDiv",children:[i.jsxs("h2",{children:["Linije ","("+(d==null?void 0:d.name)+")"]}),i.jsx("input",{type:"text",placeholder:m==="arrivals"?"Išči po številki linije...":"Išči linije...",className:"search-input",value:h,onChange:e=>D(e.target.value)}),i.jsxs("div",{className:"top-nav",children:[i.jsx("button",{className:m==="arrivals"?"active":"",onClick:()=>j("arrivals"),children:"Prihodi"}),i.jsx("button",{className:m==="all"?"active":"",onClick:()=>j("all"),children:"Vse"}),i.jsx("button",{className:m==="liked"?"active":"",onClick:()=>j("liked"),children:"Priljubljene"})]}),i.jsxs("div",{className:"results",children:[m==="arrivals"&&i.jsxs("div",{className:"arrival-list",children:[y.length===0&&i.jsx("p",{className:"empty-message",children:"Ni prihodov na tej postaji."}),y.map((e,t)=>i.jsx(A,{arrival:e},`arrival-${t}`))]}),m==="all"&&i.jsxs(i.Fragment,{children:[h.length<1&&i.jsx("p",{className:"empty-message",children:"Vnesite številko linije ali ime."}),h.length>=1&&R.length===0&&i.jsx("p",{className:"empty-message",children:"Ni rezultatov."}),i.jsx("ul",{className:"route-list",children:R.map((e,t)=>i.jsx(P,{item:e,isLiked:z(e),onToggleLike:n=>w(e,n),onClick:()=>k(e)},`route-${t}`))})]}),m==="liked"&&i.jsxs(i.Fragment,{children:[S.length===0&&i.jsx("p",{className:"empty-message",children:"Ni priljubljenih linij. Kliknite na ❤️ za dodajanje."}),i.jsx("ul",{className:"route-list",children:S.map((e,t)=>{const s=f.find(o=>u(o)===e.id)||{lineName:e.name,lineNumber:e.lineNumber,operator:e.operator,headsign:e.headsign,tripId:e.tripId,lineId:e.lineId,routeId:e.routeId};return i.jsx(P,{item:s,isLiked:!0,onToggleLike:o=>w(s,o),onClick:()=>k(s)},`liked-${t}`)})})]})]})]})};export{U as default};
